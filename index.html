<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher Alex English Academy</title>
    
    <!-- PWA -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2b4c7e">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <!-- CSS Universal -->
    <link rel="stylesheet" href="src/styles/base.css">
    <link rel="stylesheet" href="src/styles/layout.css">
    <link rel="stylesheet" href="src/styles/theme-patriot.css">
</head>
<body>
    <!-- User Widget -->
    <div class="user-widget">
        <div class="user-avatar" id="userAvatar">A</div>
        <span class="user-name" id="userName">Aluno</span>
        <button class="logout-btn" onclick="logout()">Sair</button>
    </div>

    <div class="container">
        <!-- Header -->
        <header class="header">
            <h1 class="logo">Teacher Alex <span class="logo-highlight">English Academy</span></h1>
            <p class="main-subtitle" id="welcomeMsg">Bem-vindo de volta!</p>
        </header>
        
        <!-- Stats Section Title -->
        <section class="stats-section">
            <h2 class="stats-title">üìä Seu Progresso Acad√™mico</h2>
            <p class="stats-subtitle">Acompanhe sua jornada de aprendizado em tempo real</p>
        </section>
        
        <!-- Stats Dashboard -->
        <section class="stats-dashboard">
            <div class="stat-card lessons">
                <div class="stat-icon">üìö</div>
                <div class="stat-info">
                    <div class="stat-number" id="statLessons">0</div>
                    <div class="stat-label">Li√ß√µes Completas</div>
                </div>
                <div class="stat-trend" id="lessonsTrend">üìà +1</div>
            </div>
            
            <div class="stat-card chapters">
                <div class="stat-icon">üìñ</div>
                <div class="stat-info">
                    <div class="stat-number" id="statChapters">0</div>
                    <div class="stat-label">Cap√≠tulos Lidos</div>
                </div>
                <div class="stat-trend" id="chaptersTrend">üìà +1</div>
            </div>
            
            <div class="stat-card badges">
                <div class="stat-icon">üèÜ</div>
                <div class="stat-info">
                    <div class="stat-number" id="statBadges">0</div>
                    <div class="stat-label">Badges Earned</div>
                </div>
                <div class="stat-trend" id="badgesTrend">üìà +1</div>
            </div>
            
            <div class="stat-card time">
                <div class="stat-icon">‚è±Ô∏è</div>
                <div class="stat-info">
                    <div class="stat-number" id="statTime">0h</div>
                    <div class="stat-label">Tempo de Estudo</div>
                </div>
                <div class="stat-trend" id="timeTrend">üìà +1h</div>
            </div>
        </section>
        
        <!-- Main Activities -->
        <main class="hubs-grid">
            <!-- Listening Hub -->
            <div class="hub-card" onclick="navigate('listening')">
                <div class="hub-header">
                    <div class="hub-icon">üéß</div>
                    <h3 class="hub-title-card">Listening Practice</h3>
                    <p class="hub-description">Melhore sua compreens√£o auditiva com di√°logos aut√™nticos</p>
                </div>
                <div class="hub-content">
                    <ul class="hub-features">
                        <li>23 li√ß√µes interativas dispon√≠veis</li>
                        <li>√Åudios nativos de alta qualidade</li>
                        <li>Quiz de compreens√£o din√¢mico</li>
                        <li>Sistema de badges motivador</li>
                        <li>N√≠veis: Foundation ‚Üí Advanced</li>
                    </ul>
                </div>
                <div class="hub-footer">
                    <button class="hub-button">üéß Come√ßar Listening</button>
                </div>
                <div class="progress-badge" id="listeningProgress">‚ú® Pronto</div>
            </div>
            
            <!-- Graded Readers Hub -->
            <div class="hub-card" onclick="navigate('graded-readers')">
                <div class="hub-header">
                    <div class="hub-icon">üìö</div>
                    <h3 class="hub-title-card">Graded Readers</h3>
                    <p class="hub-description">Hist√≥rias organizadas por n√≠vel para absor√ß√£o natural de vocabul√°rio</p>
                </div>
                <div class="hub-content">
                    <ul class="hub-features">
                        <li>N√≠vel A1: The Roommate Problem</li>
                        <li>N√≠vel A2: The Secret House</li>
                        <li>N√≠vel B1: Em desenvolvimento</li>
                        <li>√Åudios IA de alta qualidade</li>
                        <li>Progress√£o did√°tica estruturada</li>
                    </ul>
                </div>
                <div class="hub-footer">
                    <button class="hub-button">üìö Explorar Hist√≥rias</button>
                </div>
                <div class="progress-badge" id="gradedProgress">‚ú® Pronto</div>
            </div>
            
            <!-- Pure Reading Hub -->
            <div class="hub-card" onclick="navigate('pure-reading')">
                <div class="hub-header">
                    <div class="hub-icon">üìñ</div>
                    <h3 class="hub-title-card">Pure Reading</h3>
                    <p class="hub-description">Foco 100% na interpreta√ß√£o textual sem distra√ß√µes</p>
                </div>
                <div class="hub-content">
                    <ul class="hub-features">
                        <li>A2 Low: Perfect Neighbor Story</li>
                        <li>A2 Mid: Hist√≥rias intermedi√°rias</li>
                        <li>B1: Para alunos avan√ßados</li>
                        <li>Leitura pura sem depend√™ncia de √°udio</li>
                        <li>Typography otimizada para leitura</li>
                    </ul>
                </div>
                <div class="hub-footer">
                    <button class="hub-button">üìñ Come√ßar Leitura</button>
                </div>
                <div class="progress-badge" id="pureProgress">‚ú® Pronto</div>
            </div>
            
            <!-- Secret Area -->
            <div class="hub-card coming-soon" onclick="showComingSoon()">
                <div class="hub-header">
                    <div class="hub-icon">üîí</div>
                    <h3 class="hub-title-card">Secret Area</h3>
                    <p class="hub-description">√Årea exclusiva para alunos dedicados e conquistadores</p>
                </div>
                <div class="hub-content">
                    <ul class="hub-features">
                        <li>Conte√∫do premium exclusivo</li>
                        <li>Desafios especiais avan√ßados</li>
                        <li>Certificados de conquista</li>
                        <li>Acesso via badges earned</li>
                        <li>Surpresas para dedicados</li>
                    </ul>
                </div>
                <div class="hub-footer">
                    <button class="hub-button" disabled>üöÄ Em Breve</button>
                </div>
            </div>
        </main>
        
        <!-- Footer -->
        <footer class="footer">
            <h3>üéì Teacher Alex English Academy</h3>
            <p>Sua jornada personalizada para dominar o ingl√™s americano!</p>
            <p>Contato direto: <a href="mailto:alexmg@gmail.com" class="contact-link">alexmg@gmail.com</a></p>
        </footer>
    </div>

    <script>
        // ===== AUTH CHECK =====
        if (sessionStorage.getItem('studentLoggedIn') !== 'true') {
            window.location.href = 'pages/auth/login.html';
        }

        // ===== INITIALIZATION =====
        const studentName = sessionStorage.getItem('studentUsername') || 'Student';
        
        // Clear any existing timers on page load
        clearAllTimers();
        
        // Store previous stats for comparison
        let previousStats = JSON.parse(localStorage.getItem(`previousStats_${studentName}`)) || {
            lessons: 0, chapters: 0, badges: 0, time: 0
        };
        
        // Update UI with student info
        document.getElementById('userName').textContent = studentName;
        document.getElementById('userAvatar').textContent = studentName.charAt(0).toUpperCase();
        document.getElementById('welcomeMsg').textContent = `Bem-vindo de volta, ${studentName}!`;

        // ===== EMERGENCY FUNCTIONS =====
        window.clearStatsAnimations = function() {
            clearAllTimers();
            setDefaultStats();
            console.log('üÜò Anima√ß√µes de stats resetadas com sucesso!');
        };

        window.debugStats = function() {
            const progressKey = `progress_${studentName}`;
            const saved = localStorage.getItem(progressKey);
            console.log('üîç Debug Stats:', {
                studentName,
                savedData: saved ? JSON.parse(saved) : null,
                previousStats,
                activeTimers: activeTimers.length
            });
        };

        // ===== PROGRESS DEBUG FUNCTIONS =====
        window.checkProgress = function() {
            const progressKey = `progress_${studentName}`;
            const saved = localStorage.getItem(progressKey);
            
            console.log('üìä DIAGN√ìSTICO COMPLETO DE PROGRESSO:');
            console.log('üë§ Aluno:', studentName);
            console.log('üîë Chave localStorage:', progressKey);
            
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    console.log('üíæ Dados salvos:', data);
                    
                    // Verificar cada se√ß√£o
                    console.log('üéß Listening:', data.listening || 'N√£o encontrado');
                    console.log('üìñ Reading:', data.reading || 'N√£o encontrado');
                    console.log('üè† Roommate:', data.roommate || 'N√£o encontrado');
                    console.log('ü§ù Neighbor:', data.neighbor || 'N√£o encontrado');
                    
                    // Calcular totais
                    const listeningLessons = data.listening?.lessonsCompleted?.length || 0;
                    const readingChapters = data.reading?.chaptersCompleted?.length || 0;
                    const roommateChapters = data.roommate?.chaptersCompleted?.length || 0;
                    const neighborChapters = data.neighbor?.chaptersCompleted?.length || 0;
                    
                    console.log('üìà TOTAIS CALCULADOS:');
                    console.log('   Listening Lessons:', listeningLessons);
                    console.log('   Reading Chapters:', readingChapters);
                    console.log('   Roommate Chapters:', roommateChapters);
                    console.log('   Neighbor Chapters:', neighborChapters);
                    console.log('   TOTAL CHAPTERS:', readingChapters + roommateChapters + neighborChapters);
                    
                } catch (e) {
                    console.error('‚ùå Erro ao ler dados:', e);
                }
            } else {
                console.log('‚ùå Nenhum dado encontrado no localStorage');
            }
        };

        window.forceRefreshStats = function() {
            console.log('üîÑ For√ßando atualiza√ß√£o de stats...');
            clearAllTimers();
            loadStats();
        };

        window.showAllLocalStorage = function() {
            console.log('üíæ TODOS OS DADOS DO LOCALSTORAGE:');
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                const value = localStorage.getItem(key);
                console.log(`${key}:`, value);
            }
        };

        // ===== TESTE DE PROGRESSO =====
        window.simulateProgress = function() {
            const progressKey = `progress_${studentName}`;
            const testData = {
                listening: {
                    lessonsCompleted: [1, 2, 3],
                    badges: ['beginner', 'intermediate']
                },
                reading: {
                    chaptersCompleted: [1, 2],
                    badges: ['reader']
                },
                roommate: {
                    chaptersCompleted: [1, 2, 3],
                    badges: ['story-lover']
                },
                neighbor: {
                    chaptersCompleted: [1],
                    badges: ['neighbor-friend']
                },
                totalStudyTime: 7200000 // 2 hours in milliseconds
            };
            
            localStorage.setItem(progressKey, JSON.stringify(testData));
            console.log('‚úÖ Dados de teste salvos!');
            console.log('üîÑ Recarregando stats...');
            forceRefreshStats();
        };

        window.clearAllProgress = function() {
            if (confirm('‚ö†Ô∏è Isso vai apagar TODO o progresso! Tem certeza?')) {
                const progressKey = `progress_${studentName}`;
                localStorage.removeItem(progressKey);
                localStorage.removeItem(`previousStats_${studentName}`);
                console.log('üóëÔ∏è Progresso limpo!');
                forceRefreshStats();
            }
        };

        // ===== STATS DASHBOARD =====
        function loadStats() {
            // Clear any existing timers first
            clearAllTimers();
            
            const progressKey = `progress_${studentName}`;
            const saved = localStorage.getItem(progressKey);
            
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    
                    // Calculate lessons completed
                    const listeningLessons = data.listening?.lessonsCompleted?.length || 0;
                    const totalLessons = listeningLessons;
                    
                    // Calculate chapters completed
                    const readingChapters = data.reading?.chaptersCompleted?.length || 0;
                    const roommateChapters = data.roommate?.chaptersCompleted?.length || 0;
                    const neighborChapters = data.neighbor?.chaptersCompleted?.length || 0;
                    const totalChapters = readingChapters + roommateChapters + neighborChapters;
                    
                    // Calculate badges earned
                    const listeningBadges = data.listening?.badges?.length || 0;
                    const readingBadges = data.reading?.badges?.length || 0;
                    const roommateBadges = data.roommate?.badges?.length || 0;
                    const neighborBadges = data.neighbor?.badges?.length || 0;
                    const totalBadges = listeningBadges + readingBadges + roommateBadges + neighborBadges;
                    
                    // Calculate study time (convert from milliseconds to hours)
                    const totalStudyTime = data.totalStudyTime || 0;
                    const studyHours = Math.floor(totalStudyTime / (1000 * 60 * 60));
                    
                    // Compare with previous stats for trend indicators
                    const currentStats = { lessons: totalLessons, chapters: totalChapters, badges: totalBadges, time: studyHours };
                    
                    // Animate numbers updating with trend comparison
                    animateStatWithTrend('statLessons', totalLessons, previousStats.lessons);
                    animateStatWithTrend('statChapters', totalChapters, previousStats.chapters);
                    animateStatWithTrend('statBadges', totalBadges, previousStats.badges);
                    animateStatWithTrend('statTime', studyHours, previousStats.time, 'h');
                    
                    // Store current stats as previous for next time
                    localStorage.setItem(`previousStats_${studentName}`, JSON.stringify(currentStats));
                    
                    // Debug info
                    console.log('üìä Stats calculados:', currentStats);
                    console.log('üìà Progresso desde √∫ltima sess√£o:', {
                        lessons: totalLessons - previousStats.lessons,
                        chapters: totalChapters - previousStats.chapters,
                        badges: totalBadges - previousStats.badges,
                        time: studyHours - previousStats.time
                    });
                    
                    // Add special effects for high achievers
                    checkHighAchievements(totalLessons, totalChapters, totalBadges, studyHours);
                    
                    // Update progress badges based on completion
                    updateProgressBadges(data);
                    
                } catch (e) {
                    console.error('Erro ao carregar estat√≠sticas:', e);
                    // Set default values if there's an error
                    setDefaultStats();
                    updateProgressBadges({});
                }
            } else {
                // Set default values for new users
                setDefaultStats();
            }
        }

        function animateStatNumber(elementId, targetValue, suffix = '') {
            const element = document.getElementById(elementId);
            const startValue = parseInt(element.textContent) || 0;
            const increment = targetValue > startValue ? 1 : -1;
            const stepTime = Math.abs(Math.floor(300 / (targetValue - startValue)));
            
            // Show trend indicator if increasing
            if (targetValue > startValue) {
                element.classList.add('achievement');
                setTimeout(() => element.classList.remove('achievement'), 2000);
                
                // Show trend indicator
                const trendMap = {
                    'statLessons': 'lessonsTrend',
                    'statChapters': 'chaptersTrend',
                    'statBadges': 'badgesTrend',
                    'statTime': 'timeTrend'
                };
                
                const trendElement = document.getElementById(trendMap[elementId]);
                if (trendElement) {
                    const difference = targetValue - startValue;
                    trendElement.textContent = `üìà +${difference}${suffix}`;
                    trendElement.classList.add('growing');
                    setTimeout(() => trendElement.classList.remove('growing'), 4000);
                }
            }
            
            let currentValue = startValue;
            const timer = setInterval(() => {
                currentValue += increment;
                element.textContent = currentValue + suffix;
                
                if (currentValue === targetValue) {
                    clearInterval(timer);
                }
            }, stepTime);
        }

        function checkHighAchievements(lessons, chapters, badges, hours) {
            // Remove any existing high-achiever classes
            document.querySelectorAll('.stat-card').forEach(card => {
                card.classList.remove('high-achiever');
            });
            
            // Add high-achiever effect for significant milestones
            const lessonsCard = document.querySelector('.stat-card.lessons');
            const chaptersCard = document.querySelector('.stat-card.chapters');
            const badgesCard = document.querySelector('.stat-card.badges');
            const timeCard = document.querySelector('.stat-card.time');
            
            if (lessons >= 5 && lessonsCard) {
                lessonsCard.classList.add('high-achiever');
            }
            if (chapters >= 3 && chaptersCard) {
                chaptersCard.classList.add('high-achiever');
            }
            if (badges >= 3 && badgesCard) {
                badgesCard.classList.add('high-achiever');
            }
            if (hours >= 2 && timeCard) {
                timeCard.classList.add('high-achiever');
            }
            
            // Special celebration for exceptional achievements
            if (lessons >= 10 || chapters >= 8 || badges >= 5 || hours >= 5) {
                showCelebrationMessage();
            }
        }

        function showCelebrationMessage() {
            const messages = [
                'üéâ Parab√©ns! Voc√™ √© um aluno excepcional!',
                '‚≠ê Seu progresso est√° impressionante!',
                'üèÜ Continue assim - voc√™ est√° indo muito bem!',
                'üî• Dedica√ß√£o exemplar! Keep it up!'
            ];
            
            setTimeout(() => {
                const randomMessage = messages[Math.floor(Math.random() * messages.length)];
                if (confirm(randomMessage + '\n\nQuer continuar estudando?')) {
                    // User clicked OK, they want to continue
                    console.log('Aluno motivado a continuar!');
                }
            }, 2000);
        }

        function setDefaultStats() {
            animateStatNumber('statLessons', 0);
            animateStatNumber('statChapters', 0);
            animateStatNumber('statBadges', 0);
            animateStatNumber('statTime', 0, 'h');
        }

        function updateProgressBadges(data) {
            // Listening progress
            const listeningCompleted = data.listening?.lessonsCompleted?.length || 0;
            const listeningBadge = document.getElementById('listeningProgress');
            if (listeningBadge) {
                if (listeningCompleted > 0) {
                    listeningBadge.textContent = `${listeningCompleted} ‚úì`;
                    listeningBadge.style.background = 'var(--success)';
                } else {
                    listeningBadge.textContent = '‚ú® Pronto';
                    listeningBadge.style.background = 'var(--blue-medium)';
                }
            }
            
            // Graded readers progress
            const roommateCompleted = data.roommate?.chaptersCompleted?.length || 0;
            const readingCompleted = data.reading?.chaptersCompleted?.length || 0;
            const gradedBadge = document.getElementById('gradedProgress');
            if (gradedBadge) {
                const totalGradedChapters = roommateCompleted + readingCompleted;
                if (totalGradedChapters > 0) {
                    gradedBadge.textContent = `${totalGradedChapters} ‚úì`;
                    gradedBadge.style.background = 'var(--success)';
                } else {
                    gradedBadge.textContent = '‚ú® Pronto';
                    gradedBadge.style.background = 'var(--blue-medium)';
                }
            }
            
            // Pure reading progress
            const neighborCompleted = data.neighbor?.chaptersCompleted?.length || 0;
            const pureBadge = document.getElementById('pureProgress');
            if (pureBadge) {
                if (neighborCompleted > 0) {
                    pureBadge.textContent = `${neighborCompleted} ‚úì`;
                    pureBadge.style.background = 'var(--success)';
                } else {
                    pureBadge.textContent = '‚ú® Pronto';
                    pureBadge.style.background = 'var(--blue-medium)';
                }
            }
        }

        // ===== NAVIGATION SYSTEM =====
        function navigate(section) {
            const card = event.currentTarget;
            const button = card.querySelector('.hub-button');
            const originalText = button.textContent;
            
            // Loading state
            button.textContent = 'Carregando...';
            card.style.opacity = '0.7';
            
            const routes = {
                'listening': 'pages/hubs/listening-hub.html',
                'graded-readers': 'pages/hubs/graded-readers-hub.html',
                'pure-reading': 'pages/hubs/pure-reading-hub.html'
            };
            
            setTimeout(() => {
                if (routes[section]) {
                    window.location.href = routes[section];
                } else {
                    // Restore button if route doesn't exist
                    button.textContent = originalText;
                    card.style.opacity = '1';
                    alert('üöÄ Se√ß√£o em desenvolvimento!');
                }
            }, 500);
        }

        function showComingSoon() {
            const messages = [
                'üîí A Secret Area est√° sendo preparada especialmente para voc√™s!',
                'üèÜ Continue ganhando badges para desbloquear conte√∫do exclusivo!',
                '‚≠ê Algo incr√≠vel est√° vindo para os alunos mais dedicados!',
                'üéØ Mantenha o foco nos estudos - surpresas est√£o chegando!'
            ];
            alert(messages[Math.floor(Math.random() * messages.length)]);
        }

        // ===== LOGOUT FUNCTION =====
        function logout() {
            if (confirm('Tem certeza que deseja sair?')) {
                sessionStorage.clear();
                window.location.href = 'pages/auth/login.html';
            }
        }

        // ===== PWA SERVICE WORKER =====
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js')
                .then(registration => {
                    console.log('üîß Service Worker registrado com sucesso:', registration);
                })
                .catch(error => {
                    console.log('‚ùå Falha ao registrar Service Worker:', error);
                });
        }

        // ===== PAGE CLEANUP =====
        let sessionStartTime = Date.now();
        
        window.addEventListener('beforeunload', () => {
            // Clean up any running timers
            clearAllTimers();
            
            const sessionTime = Date.now() - sessionStartTime;
            const progressKey = `progress_${studentName}`;
            const saved = localStorage.getItem(progressKey);
            
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    data.totalStudyTime = (data.totalStudyTime || 0) + sessionTime;
                    localStorage.setItem(progressKey, JSON.stringify(data));
                } catch (e) {
                    console.error('Erro ao salvar tempo de estudo:', e);
                }
            }
        });

        // Also cleanup on page hide (mobile browsers)
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                clearAllTimers();
            }
        });

        // ===== INITIALIZATION =====
        loadStats();
        
        console.log('üéì TEACHER ALEX ENGLISH ACADEMY carregado!');
        console.log('üë§ Usu√°rio logado:', studentName);
        console.log('üìä STATS PREMIUM ativado: gradientes, anima√ß√µes, tend√™ncias, conquistas');
        console.log('‚ú® Recursos especiais: high-achiever effects, celebration messages, trend indicators');
        console.log('üéØ Sistema de motiva√ß√£o completo para alunos adultos!');
        console.log('');
        console.log('üÜò FUN√á√ïES DE EMERG√äNCIA:');
        console.log('   clearStatsAnimations() - Para parar anima√ß√µes infinitas');
        console.log('   debugStats() - Para debugar dados do localStorage');
        console.log('');
        console.log('üîç FUN√á√ïES DE DEBUG DE PROGRESSO:');
        console.log('   checkProgress() - Diagn√≥stico completo do progresso');
        console.log('   forceRefreshStats() - For√ßar atualiza√ß√£o dos stats');
        console.log('   showAllLocalStorage() - Ver todos os dados salvos');
        console.log('');
        console.log('üí° PARA RESOLVER PROBLEMA DE PROGRESSO:');
        console.log('   1. Digite: checkProgress()');
        console.log('   2. Veja se os dados est√£o sendo salvos corretamente');
        console.log('   3. Se n√£o, me informe o que aparece no console!');
        console.log('');
        console.log('üß™ FUN√á√ïES DE TESTE:');
        console.log('   simulateProgress() - Criar dados de teste');
        console.log('   clearAllProgress() - Limpar todo o progresso');
        console.log('   showAllLocalStorage() - Ver todos os dados');
        console.log('');
        console.log('üî• ALEX, SIGA ESTES PASSOS:');
        console.log('   1. Complete um cap√≠tulo no graded reader');
        console.log('   2. Volte para o dashboard');
        console.log('   3. Digite: checkProgress()');
        console.log('   4. Me envie a sa√≠da do console!');
    </script>
</body>
</html>
