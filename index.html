<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher Alex English Academy</title>
    
    <!-- PWA -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2b4c7e">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <!-- CSS Universal -->
    <link rel="stylesheet" href="src/styles/base.css">
    <link rel="stylesheet" href="src/styles/layout.css">
    <link rel="stylesheet" href="src/styles/theme-patriot.css">

    <!-- No <head> de TODAS as páginas -->
    <script src="../../src/scripts/core/navigation-fix.js"></script>
    
</head>
<body>
    <!-- User Widget -->
    <div class="user-widget">
        <div class="user-avatar" id="userAvatar">A</div>
        <span class="user-name" id="userName">Aluno</span>
        <button class="logout-btn" onclick="logout()">Sair</button>
    </div>

    <div class="container">
        <!-- Header -->
        <header class="header">
            <h1 class="logo">Teacher Alex <span class="logo-highlight">English Academy</span></h1>
            <p class="main-subtitle" id="welcomeMsg">Bem-vindo de volta!</p>
        </header>
        
        <!-- Stats Section Title -->
        <section class="stats-section">
            <h2 class="stats-title">📊 Seu Progresso Acadêmico</h2>
            <p class="stats-subtitle">Acompanhe sua jornada de aprendizado em tempo real</p>
        </section>
        
        <!-- Stats Dashboard -->
        <section class="stats-dashboard">
            <div class="stat-card lessons">
                <div class="stat-icon">📚</div>
                <div class="stat-info">
                    <div class="stat-number" id="statLessons">0</div>
                    <div class="stat-label">Lições Completas</div>
                </div>
                <div class="stat-trend" id="lessonsTrend">📈 +1</div>
            </div>
            
            <div class="stat-card chapters">
                <div class="stat-icon">📖</div>
                <div class="stat-info">
                    <div class="stat-number" id="statChapters">0</div>
                    <div class="stat-label">Capítulos Lidos</div>
                </div>
                <div class="stat-trend" id="chaptersTrend">📈 +1</div>
            </div>
            
            <div class="stat-card badges">
                <div class="stat-icon">🏆</div>
                <div class="stat-info">
                    <div class="stat-number" id="statBadges">0</div>
                    <div class="stat-label">Badges Earned</div>
                </div>
                <div class="stat-trend" id="badgesTrend">📈 +1</div>
            </div>
            
            <div class="stat-card time">
                <div class="stat-icon">⏱️</div>
                <div class="stat-info">
                    <div class="stat-number" id="statTime">0h</div>
                    <div class="stat-label">Tempo de Estudo</div>
                </div>
                <div class="stat-trend" id="timeTrend">📈 +1h</div>
            </div>
        </section>
        
        <!-- Main Activities -->
        <main class="hubs-grid">
            <!-- Listening Hub -->
            <div class="hub-card" onclick="navigate('listening')">
                <div class="hub-header">
                    <div class="hub-icon">🎧</div>
                    <h3 class="hub-title-card">Listening Practice</h3>
                    <p class="hub-description">Melhore sua compreensão auditiva com diálogos autênticos</p>
                </div>
                <div class="hub-content">
                    <ul class="hub-features">
                        <li>23 lições interativas disponíveis</li>
                        <li>Áudios nativos de alta qualidade</li>
                        <li>Quiz de compreensão dinâmico</li>
                        <li>Sistema de badges motivador</li>
                        <li>Níveis: Foundation → Advanced</li>
                    </ul>
                </div>
                <div class="hub-footer">
                    <button class="hub-button">🎧 Começar Listening</button>
                </div>
                <div class="progress-badge" id="listeningProgress">✨ Pronto</div>
            </div>
            
            <!-- Graded Readers Hub -->
            <div class="hub-card" onclick="navigate('graded-readers')">
                <div class="hub-header">
                    <div class="hub-icon">📚</div>
                    <h3 class="hub-title-card">Graded Readers</h3>
                    <p class="hub-description">Histórias organizadas por nível para absorção natural de vocabulário</p>
                </div>
                <div class="hub-content">
                    <ul class="hub-features">
                        <li>Nível A1: The Roommate Problem</li>
                        <li>Nível A2: The Secret House</li>
                        <li>Nível B1: Em desenvolvimento</li>
                        <li>Áudios IA de alta qualidade</li>
                        <li>Progressão didática estruturada</li>
                    </ul>
                </div>
                <div class="hub-footer">
                    <button class="hub-button">📚 Explorar Histórias</button>
                </div>
                <div class="progress-badge" id="gradedProgress">✨ Pronto</div>
            </div>
            
            <!-- Pure Reading Hub -->
            <div class="hub-card" onclick="navigate('pure-reading')">
                <div class="hub-header">
                    <div class="hub-icon">📖</div>
                    <h3 class="hub-title-card">Pure Reading</h3>
                    <p class="hub-description">Foco 100% na interpretação textual sem distrações</p>
                </div>
                <div class="hub-content">
                    <ul class="hub-features">
                        <li>A2 Low: Perfect Neighbor Story</li>
                        <li>A2 Mid: Histórias intermediárias</li>
                        <li>B1: Para alunos avançados</li>
                        <li>Leitura pura sem dependência de áudio</li>
                        <li>Typography otimizada para leitura</li>
                    </ul>
                </div>
                <div class="hub-footer">
                    <button class="hub-button">📖 Começar Leitura</button>
                </div>
                <div class="progress-badge" id="pureProgress">✨ Pronto</div>
            </div>
            
            <!-- Secret Area -->
            <div class="hub-card coming-soon" onclick="showComingSoon()">
                <div class="hub-header">
                    <div class="hub-icon">🔒</div>
                    <h3 class="hub-title-card">Secret Area</h3>
                    <p class="hub-description">Área exclusiva para alunos dedicados e conquistadores</p>
                </div>
                <div class="hub-content">
                    <ul class="hub-features">
                        <li>Conteúdo premium exclusivo</li>
                        <li>Desafios especiais avançados</li>
                        <li>Certificados de conquista</li>
                        <li>Acesso via badges earned</li>
                        <li>Surpresas para dedicados</li>
                    </ul>
                </div>
                <div class="hub-footer">
                    <button class="hub-button" disabled>🚀 Em Breve</button>
                </div>
            </div>
        </main>
        
        <!-- Footer -->
        <footer class="footer">
            <h3>🎓 Teacher Alex English Academy</h3>
            <p>Sua jornada personalizada para dominar o inglês americano!</p>
            <p>Contato direto: <a href="mailto:alexmg@gmail.com" class="contact-link">alexmg@gmail.com</a></p>
        </footer>
    </div>

    <script>
        // ===== UNIVERSAL PROGRESS SYSTEM =====
        class ProgressManager {
            constructor() {
                this.studentName = sessionStorage.getItem('studentUsername') || 'Student';
                this.progressKey = `progress_${this.studentName}`;
                this.init();
            }

            init() {
                this.ensureProgressStructure();
                console.log('📊 Progress Manager initialized for:', this.studentName);
            }

            ensureProgressStructure() {
                const data = this.getAllProgress();
                let updated = false;

                const sections = ['listening', 'reading', 'roommate', 'neighbor'];
                sections.forEach(section => {
                    if (!data[section]) {
                        data[section] = {
                            chaptersCompleted: [],
                            badges: [],
                            lastAccessed: Date.now()
                        };
                        updated = true;
                    }
                });

                if (!data.totalStudyTime) {
                    data.totalStudyTime = 0;
                    updated = true;
                }

                if (updated) {
                    this.saveAllProgress(data);
                    console.log('✅ Progress structure created/updated');
                }
            }

            getAllProgress() {
                const saved = localStorage.getItem(this.progressKey);
                if (saved) {
                    try {
                        return JSON.parse(saved);
                    } catch (e) {
                        console.error('❌ Error parsing progress data:', e);
                        return {};
                    }
                }
                return {};
            }

            saveAllProgress(data) {
                localStorage.setItem(this.progressKey, JSON.stringify(data));
                console.log('💾 Progress saved:', data);
            }

            getStatistics() {
                const data = this.getAllProgress();
                
                let totalLessons = 0;
                let totalChapters = 0;
                let totalBadges = 0;
                
                Object.keys(data).forEach(key => {
                    if (data[key] && data[key].chaptersCompleted) {
                        if (key === 'listening') {
                            totalLessons += data[key].chaptersCompleted.length;
                        } else {
                            totalChapters += data[key].chaptersCompleted.length;
                        }
                    }
                    
                    if (data[key] && data[key].badges) {
                        totalBadges += data[key].badges.length;
                    }
                });
                
                const studyHours = Math.floor((data.totalStudyTime || 0) / (1000 * 60 * 60));
                
                return {
                    lessons: Math.min(50, Math.max(0, totalLessons)),
                    chapters: Math.min(100, Math.max(0, totalChapters)),
                    badges: Math.min(50, Math.max(0, totalBadges)),
                    studyHours: Math.min(999, Math.max(0, studyHours)),
                    raw: data
                };
            }

            debugProgress() {
                const data = this.getAllProgress();
                const stats = this.getStatistics();
                
                console.log('🔍 PROGRESS DEBUG:', {
                    studentName: this.studentName,
                    progressKey: this.progressKey,
                    rawData: data,
                    statistics: stats
                });
                
                return { data, stats };
            }
        }

        // ===== AUTH CHECK =====
        if (sessionStorage.getItem('studentLoggedIn') !== 'true') {
            window.location.href = 'pages/auth/login.html';
        }

        // ===== EMERGENCY TIMER CLEANUP =====
        let activeTimers = [];
        
        function clearAllTimers() {
            activeTimers.forEach(timer => clearInterval(timer));
            activeTimers = [];
        }

        // ===== INITIALIZATION =====
        const studentName = sessionStorage.getItem('studentUsername') || 'Student';
        const progressManager = new ProgressManager();
        
        // Clear any existing timers on page load
        clearAllTimers();
        
        // Store previous stats for comparison
        let previousStats = JSON.parse(localStorage.getItem(`previousStats_${studentName}`)) || {
            lessons: 0, chapters: 0, badges: 0, time: 0
        };
        
        // Update UI with student info
        document.getElementById('userName').textContent = studentName;
        document.getElementById('userAvatar').textContent = studentName.charAt(0).toUpperCase();
        document.getElementById('welcomeMsg').textContent = `Bem-vindo de volta, ${studentName}!`;

        // ===== STATS DASHBOARD - IMPROVED VERSION =====
        function loadStats() {
            clearAllTimers();
            
            const stats = progressManager.getStatistics();
            
            console.log('📊 Stats from Progress Manager:', stats);
            
            // Compare with previous stats for trend indicators
            const currentStats = { 
                lessons: stats.lessons, 
                chapters: stats.chapters, 
                badges: stats.badges, 
                time: stats.studyHours 
            };
            
            // Animate with safety checks
            animateStatWithTrend('statLessons', stats.lessons, previousStats.lessons);
            animateStatWithTrend('statChapters', stats.chapters, previousStats.chapters);
            animateStatWithTrend('statBadges', stats.badges, previousStats.badges);
            animateStatWithTrend('statTime', stats.studyHours, previousStats.time, 'h');
            
            // Store current stats as previous for next time
            localStorage.setItem(`previousStats_${studentName}`, JSON.stringify(currentStats));
            
            // Add special effects for high achievers
            checkHighAchievements(stats.lessons, stats.chapters, stats.badges, stats.studyHours);
            
            // Update progress badges based on completion
            updateProgressBadges(stats.raw);
      

        }

        function animateStatWithTrend(elementId, targetValue, previousValue, suffix = '') {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            // Convert to numbers safely
            const startValue = parseInt(element.textContent.replace(/[^0-9]/g, '')) || 0;
            const target = parseInt(targetValue) || 0;
            
            // Skip animation if no change or invalid values
            if (target === startValue || target < 0 || target > 1000) {
                element.textContent = target + suffix;
                return;
            }
            
            // Show trend indicator based on comparison with previous session
            if (target > previousValue) {
                element.classList.add('achievement');
                setTimeout(() => element.classList.remove('achievement'), 2000);
                
                // Show trend indicator
                const trendMap = {
                    'statLessons': 'lessonsTrend',
                    'statChapters': 'chaptersTrend',
                    'statBadges': 'badgesTrend',
                    'statTime': 'timeTrend'
                };
                
                const trendElement = document.getElementById(trendMap[elementId]);
                if (trendElement) {
                    const difference = target - previousValue;
                    trendElement.textContent = `📈 +${difference}${suffix}`;
                    trendElement.classList.add('growing');
                    setTimeout(() => trendElement.classList.remove('growing'), 4000);
                }
            }
            
            // Simple animation with safety checks
            const difference = Math.abs(target - startValue);
            const increment = target > startValue ? 1 : -1;
            const stepTime = Math.max(50, Math.floor(1000 / difference));
            
            let currentValue = startValue;
            let steps = 0;
            const maxSteps = difference;
            
            const timer = setInterval(() => {
                steps++;
                currentValue += increment;
                element.textContent = currentValue + suffix;
                
                // Multiple safety conditions
                if (currentValue === target || steps >= maxSteps || steps > 50) {
                    clearInterval(timer);
                    element.textContent = target + suffix;
                    // Remove from active timers
                    const index = activeTimers.indexOf(timer);
                    if (index > -1) activeTimers.splice(index, 1);
                }
            }, stepTime);
            
            // Track active timer
            activeTimers.push(timer);
        }

        function setDefaultStats() {
            clearAllTimers();
            
            document.getElementById('statLessons').textContent = '0';
            document.getElementById('statChapters').textContent = '0';
            document.getElementById('statBadges').textContent = '0';
            document.getElementById('statTime').textContent = '0h';
        }

        function checkHighAchievements(lessons, chapters, badges, hours) {
            document.querySelectorAll('.stat-card').forEach(card => {
                card.classList.remove('high-achiever');
            });
            
            const lessonsCard = document.querySelector('.stat-card.lessons');
            const chaptersCard = document.querySelector('.stat-card.chapters');
            const badgesCard = document.querySelector('.stat-card.badges');
            const timeCard = document.querySelector('.stat-card.time');
            
            if (lessons >= 5 && lessonsCard) {
                lessonsCard.classList.add('high-achiever');
            }
            if (chapters >= 3 && chaptersCard) {
                chaptersCard.classList.add('high-achiever');
            }
            if (badges >= 3 && badgesCard) {
                badgesCard.classList.add('high-achiever');
            }
            if (hours >= 2 && timeCard) {
                timeCard.classList.add('high-achiever');
            }
            
            if (lessons >= 10 || chapters >= 8 || badges >= 5 || hours >= 5) {
                showCelebrationMessage();
            }
        }

        function showCelebrationMessage() {
            const messages = [
                '🎉 Parabéns! Você é um aluno excepcional!',
                '⭐ Seu progresso está impressionante!',
                '🏆 Continue assim - você está indo muito bem!',
                '🔥 Dedicação exemplar! Keep it up!'
            ];
            
            setTimeout(() => {
                const randomMessage = messages[Math.floor(Math.random() * messages.length)];
                if (confirm(randomMessage + '\n\nQuer continuar estudando?')) {
                    console.log('Aluno motivado a continuar!');
                }
            }, 2000);
        }

        function updateProgressBadges(data) {
            const listeningCompleted = data.listening?.chaptersCompleted?.length || 0;
            const listeningBadge = document.getElementById('listeningProgress');
            if (listeningBadge) {
                if (listeningCompleted > 0) {
                    listeningBadge.textContent = `${listeningCompleted} ✓`;
                    listeningBadge.style.background = 'var(--success)';
                } else {
                    listeningBadge.textContent = '✨ Pronto';
                    listeningBadge.style.background = 'var(--blue-medium)';
                }
            }
            
            const roommateCompleted = data.roommate?.chaptersCompleted?.length || 0;
            const readingCompleted = data.reading?.chaptersCompleted?.length || 0;
            const gradedBadge = document.getElementById('gradedProgress');
            if (gradedBadge) {
                const totalGradedChapters = roommateCompleted + readingCompleted;
                if (totalGradedChapters > 0) {
                    gradedBadge.textContent = `${totalGradedChapters} ✓`;
                    gradedBadge.style.background = 'var(--success)';
                } else {
                    gradedBadge.textContent = '✨ Pronto';
                    gradedBadge.style.background = 'var(--blue-medium)';
                }
            }
            
            const neighborCompleted = data.neighbor?.chaptersCompleted?.length || 0;
            const pureBadge = document.getElementById('pureProgress');
            if (pureBadge) {
                if (neighborCompleted > 0) {
                    pureBadge.textContent = `${neighborCompleted} ✓`;
                    pureBadge.style.background = 'var(--success)';
                } else {
                    pureBadge.textContent = '✨ Pronto';
                    pureBadge.style.background = 'var(--blue-medium)';
                }
            }
        }

        // ===== NAVIGATION SYSTEM =====
        function navigate(section) {
            const card = event.currentTarget;
            const button = card.querySelector('.hub-button');
            const originalText = button.textContent;
            
            // Loading state
            button.textContent = 'Carregando...';
            card.style.opacity = '0.7';
            
            const routes = {
                'listening': 'pages/hubs/listening-hub.html',
                'graded-readers': 'pages/hubs/graded-readers-hub.html',
                'pure-reading': 'pages/hubs/pure-reading-hub.html'
            };
            
            setTimeout(() => {
                if (routes[section]) {
                    window.location.href = routes[section];
                } else {
                    button.textContent = originalText;
                    card.style.opacity = '1';
                    alert('🚀 Seção em desenvolvimento!');
                }
            }, 500);
        }

        function showComingSoon() {
            const messages = [
                '🔒 A Secret Area está sendo preparada especialmente para vocês!',
                '🏆 Continue ganhando badges para desbloquear conteúdo exclusivo!',
                '⭐ Algo incrível está vindo para os alunos mais dedicados!',
                '🎯 Mantenha o foco nos estudos - surpresas estão chegando!'
            ];
            alert(messages[Math.floor(Math.random() * messages.length)]);
        }

        // ===== LOGOUT FUNCTION =====
        function logout() {
            if (confirm('Tem certeza que deseja sair?')) {
                sessionStorage.clear();
                window.location.href = 'pages/auth/login.html';
            }
        }

        // ===== PWA SERVICE WORKER =====
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js')
                .then(registration => {
                    console.log('🔧 Service Worker registrado com sucesso:', registration);
                })
                .catch(error => {
                    console.log('❌ Falha ao registrar Service Worker:', error);
                });
        }

        // ===== PAGE CLEANUP =====
        let sessionStartTime = Date.now();
        
        window.addEventListener('beforeunload', () => {
            clearAllTimers();
            
            const sessionTime = Date.now() - sessionStartTime;
            if (sessionTime > 0) {
                const data = progressManager.getAllProgress();
                data.totalStudyTime = (data.totalStudyTime || 0) + sessionTime;
                progressManager.saveAllProgress(data);
            }
        });

        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                clearAllTimers();
            }
        });

        // ===== GLOBAL FUNCTIONS FOR DEBUGGING =====
        window.progressManager = progressManager;
        window.clearStatsAnimations = function() {
            clearAllTimers();
            setDefaultStats();
            console.log('🆘 Animações de stats resetadas com sucesso!');
        };

        window.debugProgress = function() {
            return progressManager.debugProgress();
        };

        window.forceRefreshStats = function() {
            console.log('🔄 Forçando atualização de stats...');
            clearAllTimers();
            loadStats();
        };

        window.simulateProgress = function() {
            const testData = {
                listening: {
                    chaptersCompleted: [1, 2, 3],
                    badges: ['beginner', 'intermediate']
                },
                reading: {
                    chaptersCompleted: [1, 2],
                    badges: ['reader']
                },
                roommate: {
                    chaptersCompleted: [1, 2, 3],
                    badges: ['story-lover']
                },
                neighbor: {
                    chaptersCompleted: [1],
                    badges: ['neighbor-friend']
                },
                totalStudyTime: 7200000
            };
            
            progressManager.saveAllProgress(testData);
            console.log('✅ Dados de teste salvos!');
            forceRefreshStats();
        };

        // ===== LISTEN FOR PROGRESS UPDATES =====
        window.addEventListener('progressUpdated', (event) => {
            console.log('📊 Progress update received:', event.detail);
            setTimeout(() => {
                forceRefreshStats();
            }, 500);
        });

        // ===== INITIALIZATION =====
        loadStats();
        
        console.log('🎓 TEACHER ALEX ENGLISH ACADEMY carregado!');
        console.log('👤 Usuário logado:', studentName);
        console.log('📊 PROGRESS MANAGER ativo - Sistema universal de progresso!');
        console.log('');
        console.log('🔥 ALEX, PARA TESTAR O PROGRESSO:');
        console.log('   1. Digite: simulateProgress() para criar dados de teste');
        console.log('   2. Digite: debugProgress() para ver dados atuais');
        console.log('   3. Digite: forceRefreshStats() para atualizar dashboard');
        console.log('   4. Complete um capítulo e volte - progresso deve aparecer!');
    </script>
</body>
</html>
