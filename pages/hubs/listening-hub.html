<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Listening Hub - Teacher Alex English Academy</title>
    
    <!-- CSS Universal - MESMO PADR√ÉO DOS OUTROS -->
    <link rel="stylesheet" href="../../src/styles/base.css">
    <link rel="stylesheet" href="../../src/styles/layout.css">
    <link rel="stylesheet" href="../../src/styles/theme-patriot.css">
</head>
<body>
    <!-- User Widget - MESMO PADR√ÉO -->
    <div class="user-widget">
        <div class="user-avatar" id="userAvatar">A</div>
        <span class="user-name" id="userName">Aluno</span>
        <button class="logout-btn" onclick="logout()">Sair</button>
    </div>

    <div class="container">
        <!-- Back Navigation - MESMO PADR√ÉO -->
        <a href="../../index.html" class="back-button">
            ‚Üê Voltar ao Dashboard
        </a>
        
        <!-- Header - MESMO PADR√ÉO DO GRADED-READERS -->
        <header class="header">
            <h1 class="logo">Teacher Alex <span class="logo-highlight">English Academy</span></h1>
            <h2 class="hub-title">üéß Listening Practice Hub</h2>
            <p class="hub-subtitle">Desenvolva sua compreens√£o auditiva com di√°logos aut√™nticos e progressivos</p>
        </header>

        <!-- Foundation Level -->
        <section class="level-section">
            <div class="level-header">
                <div class="level-badge">Foundation - A1</div>
                <div class="level-info">
                    <h2 class="level-title">Foundation Level</h2>
                    <p class="level-description">Base s√≥lida com vocabul√°rio essencial e estruturas fundamentais para construir confian√ßa auditiva</p>
                </div>
            </div>
            
            <div class="stories-grid">
                <!-- Foundation Audio - DISPON√çVEL -->
                <div class="story-card" onclick="navigateToStory('foundation')">
                    <div class="story-header">
                        <div class="story-icon">üå±</div>
                        <h3 class="story-title">Foundation Survival Kit</h3>
                        <p class="story-description">Primeiras apresenta√ß√µes e vocabul√°rio essencial</p>
                    </div>
                    <div class="story-content">
                        <ul class="story-features">
                            <li>Vocabul√°rio de sobreviv√™ncia</li>
                            <li>Frases de emerg√™ncia</li>
                            <li>Conversas b√°sicas do dia a dia</li>
                            <li>√Åudio IA de alta qualidade</li>
                            <li>Speed controls universais</li>
                        </ul>
                    </div>
                    <div class="story-footer">
                        <button class="story-button">Come√ßar Foundation</button>
                    </div>
                    <div class="progress-badge" id="foundationProgress">‚úÖ Dispon√≠vel</div>
                </div>

                <!-- Daily Essentials - EM BREVE -->
                <div class="story-card coming-soon" onclick="showComingSoon('Daily Essentials')">
                    <div class="story-header">
                        <div class="story-icon">üè†</div>
                        <h3 class="story-title">Daily Essentials</h3>
                        <p class="story-description">Fam√≠lia, casa e rotina dom√©stica</p>
                    </div>
                    <div class="story-content">
                        <ul class="story-features">
                            <li>Membros da fam√≠lia</li>
                            <li>C√¥modos e objetos da casa</li>
                            <li>Rotina di√°ria b√°sica</li>
                            <li>√Åudio IA naturalizado</li>
                            <li>Situa√ß√µes do cotidiano</li>
                        </ul>
                    </div>
                    <div class="story-footer">
                        <button class="story-button" disabled>üöÄ Em Breve</button>
                    </div>
                </div>

                <!-- Emergency English - EM BREVE -->
                <div class="story-card coming-soon" onclick="showComingSoon('Emergency English')">
                    <div class="story-header">
                        <div class="story-icon">üö®</div>
                        <h3 class="story-title">Emergency English</h3>
                        <p class="story-description">Situa√ß√µes de emerg√™ncia e ajuda</p>
                    </div>
                    <div class="story-content">
                        <ul class="story-features">
                            <li>Pedindo ajuda e dire√ß√µes</li>
                            <li>Situa√ß√µes de emerg√™ncia</li>
                            <li>Frases de cortesia</li>
                            <li>√Åudio IA expressivo</li>
                            <li>Vocabul√°rio essencial</li>
                        </ul>
                    </div>
                    <div class="story-footer">
                        <button class="story-button" disabled>üöÄ Em Breve</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Beginner Level -->
        <section class="level-section">
            <div class="level-header">
                <div class="level-badge">Beginner - A2</div>
                <div class="level-info">
                    <h2 class="level-title">Beginner Level</h2>
                    <p class="level-description">Expanda seu vocabul√°rio com di√°logos mais longos e situa√ß√µes cotidianas reais</p>
                </div>
            </div>
            
            <div class="stories-grid">
                <!-- Personal Introduction - DISPON√çVEL -->
                <div class="story-card" onclick="navigateToStory('beginner')">
                    <div class="story-header">
                        <div class="story-icon">üá∫üá∏</div>
                        <h3 class="story-title">Personal Introduction</h3>
                        <p class="story-description">Apresenta√ß√µes pessoais em contexto americano</p>
                    </div>
                    <div class="story-content">
                        <ul class="story-features">
                            <li>Conversas profissionais</li>
                            <li>Networking e apresenta√ß√µes</li>
                            <li>Cultura americana b√°sica</li>
                            <li>√Åudio IA naturalizado</li>
                            <li>Speed controls universais</li>
                        </ul>
                    </div>
                    <div class="story-footer">
                        <button class="story-button">Come√ßar Beginner</button>
                    </div>
                    <div class="progress-badge" id="beginnerProgress">‚úÖ Dispon√≠vel</div>
                </div>

                <!-- Travel & Transport - EM BREVE -->
                <div class="story-card coming-soon" onclick="showComingSoon('Travel & Transport')">
                    <div class="story-header">
                        <div class="story-icon">‚úàÔ∏è</div>
                        <h3 class="story-title">Travel & Transport</h3>
                        <p class="story-description">Viagens, aeroportos e transporte p√∫blico</p>
                    </div>
                    <div class="story-content">
                        <ul class="story-features">
                            <li>Check-in e aeroportos</li>
                            <li>Transporte p√∫blico</li>
                            <li>Hot√©is e reservas</li>
                            <li>√Åudio IA profissional</li>
                            <li>Situa√ß√µes pr√°ticas</li>
                        </ul>
                    </div>
                    <div class="story-footer">
                        <button class="story-button" disabled>üöÄ Em Breve</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Intermediate Level - ‚úÖ AGORA DISPON√çVEL! -->
        <section class="level-section">
            <div class="level-header">
                <div class="level-badge">Intermediate - B1</div>
                <div class="level-info">
                    <h2 class="level-title">Intermediate Level</h2>
                    <p class="level-description">Domine conversas complexas com m√∫ltiplos interlocutores e contextos variados</p>
                </div>
            </div>
            
            <div class="stories-grid">
                <!-- Advanced Conversations - DISPON√çVEL -->
                <div class="story-card" onclick="navigateToStory('intermediate')">
                    <div class="story-header">
                        <div class="story-icon">‚ö°</div>
                        <h3 class="story-title">Advanced Conversations</h3>
                        <p class="story-description">Conversas complexas e situa√ß√µes avan√ßadas</p>
                    </div>
                    <div class="story-content">
                        <ul class="story-features">
                            <li>Networking profissional</li>
                            <li>Resolu√ß√£o de problemas</li>
                            <li>Conversas de neg√≥cios</li>
                            <li>√Åudio IA corporativo</li>
                            <li>Speed controls universais</li>
                        </ul>
                    </div>
                    <div class="story-footer">
                        <button class="story-button">Come√ßar Intermediate</button>
                    </div>
                    <div class="progress-badge" id="intermediateProgress">‚úÖ Dispon√≠vel</div>
                </div>

                <!-- Work & Business - EM BREVE -->
                <div class="story-card coming-soon" onclick="showComingSoon('Work & Business')">
                    <div class="story-header">
                        <div class="story-icon">üíº</div>
                        <h3 class="story-title">Work & Business</h3>
                        <p class="story-description">Ambiente profissional e entrevistas</p>
                    </div>
                    <div class="story-content">
                        <ul class="story-features">
                            <li>Entrevistas de emprego</li>
                            <li>Reuni√µes de trabalho</li>
                            <li>Apresenta√ß√µes profissionais</li>
                            <li>√Åudio IA corporativo</li>
                            <li>Vocabul√°rio t√©cnico</li>
                        </ul>
                    </div>
                    <div class="story-footer">
                        <button class="story-button" disabled>üöÄ Em Breve</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Advanced Level - ‚úÖ AGORA DISPON√çVEL! -->
        <section class="level-section">
            <div class="level-header">
                <div class="level-badge">Advanced - B2</div>
                <div class="level-info">
                    <h2 class="level-title">Advanced Level</h2>
                    <p class="level-description">Desafie-se com conte√∫do nativo e express√µes complexas em situa√ß√µes profissionais</p>
                </div>
            </div>
            
            <div class="stories-grid">
                <!-- Work and Career - DISPON√çVEL -->
                <div class="story-card" onclick="navigateToStory('advanced')">
                    <div class="story-header">
                        <div class="story-icon">üü£</div>
                        <h3 class="story-title">Professional English</h3>
                        <p class="story-description">Ingl√™s profissional e planos futuros</p>
                    </div>
                    <div class="story-content">
                        <ul class="story-features">
                            <li>Vocabul√°rio corporativo</li>
                            <li>Planos de carreira</li>
                            <li>Sonhos e objetivos</li>
                            <li>Design purple premium</li>
                            <li>Speed controls universais</li>
                        </ul>
                    </div>
                    <div class="story-footer">
                        <button class="story-button">Come√ßar Advanced</button>
                    </div>
                    <div class="progress-badge" id="advancedProgress">‚úÖ Dispon√≠vel</div>
                </div>

                <!-- Real Estate & Moving - EM BREVE -->
                <div class="story-card coming-soon" onclick="showComingSoon('Real Estate & Moving')">
                    <div class="story-header">
                        <div class="story-icon">üè†</div>
                        <h3 class="story-title">Real Estate & Moving</h3>
                        <p class="story-description">Mudan√ßas, im√≥veis e novos vizinhos</p>
                    </div>
                    <div class="story-content">
                        <ul class="story-features">
                            <li>Aluguel e compra de im√≥veis</li>
                            <li>Empresas de mudan√ßa</li>
                            <li>Integra√ß√£o em novos bairros</li>
                            <li>√Åudio IA nativo</li>
                            <li>Express√µes coloquiais</li>
                        </ul>
                    </div>
                    <div class="story-footer">
                        <button class="story-button" disabled>üöÄ Em Breve</button>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Footer -->
        <footer class="footer">
            <h3>üéß Listening Practice Hub</h3>
            <p>Desenvolva sua compreens√£o auditiva com di√°logos aut√™nticos e progressivos</p>
        </footer>
    </div>

    <script>
        // ===== AUTH CHECK =====
        if (sessionStorage.getItem('studentLoggedIn') !== 'true') {
            window.location.href = '../auth/login.html';
        }

        // ===== INITIALIZATION =====
        const studentName = sessionStorage.getItem('studentUsername') || 'Student';
        
        // Update UI
        document.getElementById('userName').textContent = studentName;
        document.getElementById('userAvatar').textContent = studentName.charAt(0).toUpperCase();

        // ===== PROGRESS LOADING - TODOS OS N√çVEIS =====
        function loadProgress() {
            const progressKey = `progress_${studentName}`;
            const saved = localStorage.getItem(progressKey);
            
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    
                    // Foundation progress - SAFE ACCESS
                    const listening = data.listening || { lessonsCompleted: [] };
                    const lessonsCompleted = listening.lessonsCompleted || [];
                    
                    // Foundation
                    const foundationCompleted = lessonsCompleted.filter(lesson => lesson.startsWith('foundation')).length;
                    const foundationProgress = document.getElementById('foundationProgress');
                    if (foundationCompleted === 0) {
                        foundationProgress.textContent = '‚úÖ Dispon√≠vel';
                    } else {
                        foundationProgress.textContent = `${foundationCompleted}/3 ‚úì`;
                        foundationProgress.style.background = 'var(--success)';
                        foundationProgress.style.color = 'white';
                    }
                    
                    // Beginner
                    const beginnerCompleted = lessonsCompleted.filter(lesson => lesson.startsWith('beginner')).length;
                    const beginnerProgress = document.getElementById('beginnerProgress');
                    if (beginnerProgress) {
                        if (beginnerCompleted === 0) {
                            beginnerProgress.textContent = '‚úÖ Dispon√≠vel';
                        } else {
                            beginnerProgress.textContent = `${beginnerCompleted}/3 ‚úì`;
                            beginnerProgress.style.background = 'var(--success)';
                            beginnerProgress.style.color = 'white';
                        }
                    }
                    
                    // Intermediate
                    const intermediateCompleted = lessonsCompleted.filter(lesson => lesson.startsWith('intermediate')).length;
                    const intermediateProgress = document.getElementById('intermediateProgress');
                    if (intermediateProgress) {
                        if (intermediateCompleted === 0) {
                            intermediateProgress.textContent = '‚úÖ Dispon√≠vel';
                        } else {
                            intermediateProgress.textContent = `${intermediateCompleted}/3 ‚úì`;
                            intermediateProgress.style.background = 'var(--success)';
                            intermediateProgress.style.color = 'white';
                        }
                    }
                    
                    // Advanced - Estrutura diferente (advancedLessons)
                    const advancedLessons = data.listening.advancedLessons || { completed: [] };
                    const advancedCompleted = advancedLessons.completed.length;
                    const advancedProgress = document.getElementById('advancedProgress');
                    if (advancedProgress) {
                        if (advancedCompleted === 0) {
                            advancedProgress.textContent = '‚úÖ Dispon√≠vel';
                        } else {
                            advancedProgress.textContent = `${advancedCompleted}/2 ‚úì`;
                            advancedProgress.style.background = 'var(--success)';
                            advancedProgress.style.color = 'white';
                        }
                    }
                    
                } catch (e) {
                    console.error('Erro ao carregar progresso:', e);
                }
            }
        }

        // ===== üîß NAVIGATION - ANTI-TRAVAMENTO =====
        function navigateToStory(storyId) {
            const card = event.currentTarget;
            const button = card.querySelector('.story-button');
            const originalText = button.textContent;
            
            console.log(`üéØ Navegando para: ${storyId}`);
            
            // Loading state
            button.textContent = 'Carregando...';
            button.disabled = true;
            card.style.opacity = '0.7';
            
            // üîß TIMER DE SEGURAN√áA - Auto-reset ap√≥s 3 segundos
            const resetTimer = setTimeout(() => {
                console.log('‚ö†Ô∏è Reset autom√°tico do bot√£o por timeout');
                button.textContent = originalText;
                button.disabled = false;
                card.style.opacity = '1';
            }, 3000);
            
            // üîß LISTENER PARA PAGESHOW - Detecta voltar do navegador
            const handlePageShow = function(event) {
                if (event.persisted) {
                    console.log('üîÑ P√°gina restaurada do cache - resetando bot√µes');
                    clearTimeout(resetTimer);
                    button.textContent = originalText;
                    button.disabled = false;
                    card.style.opacity = '1';
                }
                window.removeEventListener('pageshow', handlePageShow);
            };
            
            window.addEventListener('pageshow', handlePageShow);
            
            // üîß LISTENER PARA BEFOREUNLOAD - Limpa estado antes de sair
            const handleBeforeUnload = function() {
                clearTimeout(resetTimer);
                window.removeEventListener('beforeunload', handleBeforeUnload);
            };
            
            window.addEventListener('beforeunload', handleBeforeUnload);
            
            // Navega√ß√£o com delay
            setTimeout(() => {
                clearTimeout(resetTimer);
                window.removeEventListener('pageshow', handlePageShow);
                window.removeEventListener('beforeunload', handleBeforeUnload);
                
                if (storyId === 'foundation') {
                    window.location.href = '../listening/foundation.html';
                } else if (storyId === 'beginner') {
                    window.location.href = '../listening/beginner.html';
                } else if (storyId === 'intermediate') {
                    window.location.href = '../listening/intermediate.html';
                } else if (storyId === 'advanced') {
                    window.location.href = '../listening/advanced.html';
                } else {
                    // Fallback - reset do bot√£o
                    button.textContent = originalText;
                    button.disabled = false;
                    card.style.opacity = '1';
                    alert('üöÄ P√°gina n√£o encontrada!');
                }
            }, 500);
        }

        // ===== üîß FUN√á√ÉO ADICIONAL - Reset geral de bot√µes =====
        function resetAllLoadingButtons() {
            console.log('üîÑ Resetando todos os bot√µes carregando...');
            
            document.querySelectorAll('.story-button').forEach(button => {
                if (button.textContent === 'Carregando...') {
                    // Tenta restaurar o texto original baseado no contexto
                    const card = button.closest('.story-card');
                    const isFoundation = card && card.textContent.includes('Foundation');
                    const isBeginner = card && card.textContent.includes('Personal Introduction');
                    const isIntermediate = card && card.textContent.includes('Advanced Conversations');
                    const isAdvanced = card && card.textContent.includes('Professional English');
                    
                    if (isFoundation) {
                        button.textContent = 'Come√ßar Foundation';
                    } else if (isBeginner) {
                        button.textContent = 'Come√ßar Beginner';
                    } else if (isIntermediate) {
                        button.textContent = 'Come√ßar Intermediate';
                    } else if (isAdvanced) {
                        button.textContent = 'Come√ßar Advanced';
                    } else {
                        button.textContent = 'Come√ßar Li√ß√£o';
                    }
                    
                    button.disabled = false;
                }
            });
            
            // Reset opacity dos cards
            document.querySelectorAll('.story-card').forEach(card => {
                card.style.opacity = '1';
            });
        }

        function showComingSoon(storyTitle) {
            const messages = [
                `üöÄ "${storyTitle}" est√° em desenvolvimento!`,
                `üéß Em breve teremos este listening incr√≠vel!`,
                `‚≠ê Continue praticando os n√≠veis dispon√≠veis enquanto preparamos "${storyTitle}"!`,
                `üéØ Sua dedica√ß√£o ser√° recompensada quando "${storyTitle}" for lan√ßada!`
            ];
            alert(messages[Math.floor(Math.random() * messages.length)]);
        }

        // ===== LOGOUT =====
        function logout() {
            sessionStorage.clear();
            window.location.href = '../auth/login.html';
        }

        // ===== üîß AUTO-RESET NA INICIALIZA√á√ÉO =====
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üéß Listening Hub carregado');
            
            // Reset autom√°tico de bot√µes travados
            setTimeout(resetAllLoadingButtons, 100);
            
            // Listener para detectar retorno √† p√°gina
            window.addEventListener('focus', function() {
                console.log('üëÅÔ∏è P√°gina recebeu foco - verificando bot√µes');
                setTimeout(resetAllLoadingButtons, 100);
            });
            
            // Listener para popstate (bot√£o voltar)
            window.addEventListener('popstate', function() {
                console.log('‚¨ÖÔ∏è Usu√°rio voltou - resetando bot√µes');
                resetAllLoadingButtons();
            });
            
            console.log('‚úÖ Sistema anti-travamento de bot√µes ativo');
        });

        // ===== üîß FUN√á√ÉO GLOBAL PARA DEBUG =====
        window.resetButtons = resetAllLoadingButtons;

        // ===== LOAD DATA =====
        loadProgress();
        
        console.log('üéß LISTENING HUB v4.1 - BOT√ïES ANTI-TRAVAMENTO!');
        console.log('üë§ Usu√°rio:', studentName);
        console.log('‚úÖ Visual CONSISTENTE com graded-readers-hub');
        console.log('üéØ Cores: theme-patriot.css universal');
        console.log('üîß Fix aplicado: navega√ß√£o com reset autom√°tico');
        console.log('üìÅ Navega√ß√£o funcionando:');
        console.log('   ‚Üí ../listening/foundation.html ‚úÖ');
        console.log('   ‚Üí ../listening/beginner.html ‚úÖ');
        console.log('   ‚Üí ../listening/intermediate.html ‚úÖ');
        console.log('   ‚Üí ../listening/advanced.html ‚úÖ');
        console.log('üöÄ SISTEMA LISTENING COMPLETO COM FIXES!');
    </script>
</body>
</html>
